# FOSSA's published swagger.json - REST API definition with version info
FOSSA_SWAGGER_REF      := https://app.fossa.com/api/api-docs/swagger.json

# where we record the last version
API_VERSION_FILE  := api-version.txt

#
# API is the upstream FOSSA API VERSION,
# MOD fossa-go module verion.
#
FOSSA_API_VERSION := $(shell curl -s $(FOSSA_SWAGGER_REF) | jq -r .info.version)
FOSSA_MOD_VERSION := v1.0.0

all: generate-go
.PHONY: all report-fossa-version generate-go

# download swagger.json, record new version
report-fossa-version:
	@echo "‚¨áÔ∏è Downloading $(FOSSA_SWAGGER_REF)‚Ä¶"
	curl -s -O $(FOSSA_SWAGGER_REF)
	@echo "‚úèÔ∏è Recording version $(FOSSA_API_VERSION)‚Ä¶"
	@echo $(FOSSA_API_VERSION) > $(API_VERSION_FILE)
	@echo "‚úèÔ∏è fossa-go module version will be $(FOSSA_MOD_VERSION)"

install-openapi-generator-cli:
	@echo "üîç  Checking for openapitools/openapi-generator-cli‚Ä¶"
	@docker image inspect openapitools/openapi-generator-cli > /dev/null 2>&1 \
		&& echo "‚úÖ openapitools/openapi-generator-cli is already available locally." \
		|| (echo "‚¨áÔ∏è Image not found locally, pulling‚Ä¶" && docker pull openapitools/openapi-generator-cli)

generate-go: install-openapi-generator-cli report-fossa-version
	@echo "üöÄ  Generating Go client for version $(FOSSA_API_VERSION)‚Ä¶"
	docker run --rm \
	  -u $$(id -u):$$(id -g) \
	  -v "$${PWD}:/local" \
      -e JAVA_OPTS="-Dlog.level=warn" \
	  openapitools/openapi-generator-cli generate \
	    -i $(FOSSA_SWAGGER_REF) \
	    --skip-validate-spec \
	    -g go \
	    --additional-properties=packageName=fossa,packageVersion=$(FOSSA_MOD_VERSION) \
	    --git-user-id=RobertKielty \
	    --git-repo-id=fossa-go \
	    -o /local/
	@echo "‚úÖ Done. Generated go module $(FOSSA_MOD_VERSION) for FOSSA REST API version $(FOSSA_API_VERSION)"

.PHONY: prepare-release
prepare-release:
	@echo "üîñ Preparing a release of fossa-go for FOSSA's REST API version $(FOSSA_API_VERSION)‚Ä¶"
	@git add .
	@git commit -sS -m "adds fossa-go $(FOSSA_MOD_VERSION) for REST API $(FOSSA_API_VERSION)"
	@git tag $(FOSSA_MOD_VERSION)
	@echo "‚úÖ Tagged commit as ‚Äò$(FOSSA_MOD_VERSION)‚Äô"

.PHONY: publish-release
publish-release:
	@echo "üöÄ Publishing GitHub release $(FOSSA_MOD_VERSION) for $(FOSSA_API_VERSION)‚Ä¶"
	@git push origin main
	@git push origin $(FOSSA_MOD_VERSION)
	@gh release create $(FOSSA_MOD_VERSION) \
		--title "fossa-go $(FOSSA_MOD_VERSION) for $(FOSSA_API_VERSION)" \
		--notes "FOSSA Go client, generated by openapi-generator-cli for API v$(FOSSA_API_VERSION)"
	@echo "‚úÖ Release $(FOSSA_MOD_VERSION) created on GitHub"
